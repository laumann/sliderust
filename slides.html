<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Memory, ownership and lifetimes</title>

    
    <link rel="stylesheet" href="http://doc.rust-lang.org/rust.css">
<link rel="stylesheet" href="sliderust.css">
<script src="sliderust.js"></script>


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <h1 class="title">Memory, ownership and lifetimes</h1>
    <div style="text-align: center; margin-top: 120px">
<img src="http://www.rust-lang.org/logos/rust-logo-256x256-blk.png">
</div>

<p><span style="font-size: 16pt">Thomas Bracht Laumann Jespersen</span>
<br>
<span style="font-size: 14pt">March 18, 2015</span></p>

<h1 id="what&#39;s-your-killer-rust-feature?" class='section-header'><a
                           href="#what&#39;s-your-killer-rust-feature?">What&#39;s your killer Rust feature?</a></h1>
<p>Asked on <a href="https://www.reddit.com/r/rust/comments/2x0h17/whats_your_killer_rust_feature/">reddit.com/r/rust</a></p>

<ul>
<li>The borrow checker!</li>
<li>It&#39;s the fourth flavor of memory management</li>
<li><em>I don&#39;t have to worry about aliasing anymore</em></li>
</ul>

<p>One of the primary goals of Rust is <em>memory-safety</em></p>

<h1 id="first:-why?" class='section-header'><a
                           href="#first:-why?">First: Why?</a></h1>
<ul>
<li>Why a new programming language?</li>
<li>Servo, a new experimental browser engine</li>
<li>Must have <em>safety</em></li>
</ul>

<h1 id="memory-management-(1)" class='section-header'><a
                           href="#memory-management-(1)">Memory Management (1)</a></h1>
<ul>
<li>Manual: Complete control, but error-prone</li>
<li>GC: Less control, but safer. Requires a runtime</li>
<li>Region-based: Cyclone</li>
</ul>

<h1 id="memory-management-(2)" class='section-header'><a
                           href="#memory-management-(2)">Memory Management (2)</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='ident'>void</span> <span class='ident'>helper</span>(<span class='ident'>int</span> <span class='op'>*</span><span class='ident'>slot</span>) {
    <span class='ident'>printf</span>(<span class='string'>&quot;The number was %d\n&quot;</span>, <span class='op'>*</span><span class='ident'>slot</span>);
    <span class='ident'>free</span>(<span class='ident'>x</span>);
}

<span class='ident'>int</span> <span class='ident'>main</span>() {
    <span class='ident'>int</span> <span class='op'>*</span><span class='ident'>slot</span> <span class='op'>=</span> (<span class='ident'>int</span><span class='op'>*</span>)<span class='ident'>malloc</span>(<span class='kw'>sizeof</span>(<span class='ident'>int</span>));
    <span class='op'>*</span><span class='ident'>slot</span> <span class='op'>=</span> <span class='number'>5</span>;
    <span class='ident'>helper</span>(<span class='ident'>slot</span>);
    <span class='ident'>helper</span>(<span class='ident'>slot</span>);
}
</pre>

<h1 id="(almost)-the-same-in-rust" class='section-header'><a
                           href="#(almost)-the-same-in-rust">(Almost) The Same in Rust</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>helper</span>(<span class='ident'>slot</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>u32</span><span class='op'>&gt;</span>) {
    <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;The number was {}&quot;</span>, <span class='ident'>slot</span>);
}
<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>slot</span> <span class='op'>=</span> <span class='ident'>Box</span>::<span class='ident'>new</span>(<span class='number'>5</span>); <span class='comment'>// Heap allocated</span>
    <span class='ident'>helper</span>(<span class='ident'>slot</span>);           <span class='comment'>// `slot` moved here</span>
    <span class='ident'>helper</span>(<span class='ident'>slot</span>);
}
</pre>

<p>Result:
<pre style="font-size: 18px">
&lt;anon&gt;:9:9: 9:13 error: use of moved value: <code>slot</code>
&lt;anon&gt;:9  helper(slot);
                 &#94;~~~
&lt;anon&gt;:8:9: 8:13 note: <code>slot</code> moved here because it has type <code>Box&lt;u32&gt;</code>, which is non-copyable
&lt;anon&gt;:8  helper(slot);
                 &#94;~~~
</pre></p>

<h1 id="ownership" class='section-header'><a
                           href="#ownership">Ownership</a></h1>
<ul>
<li>Rule #1: Exactly one owner to some allocated memory</li>
<li>Compiler knows exactly when a given piece of memory can be dropped</li>
<li>Ownership can be transferred</li>
</ul>
<pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>helper</span>() <span class='op'>-&gt;</span> <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>u32</span><span class='op'>&gt;</span> {
    <span class='kw'>let</span> <span class='ident'>slot</span> <span class='op'>=</span> <span class='ident'>Box</span>::<span class='ident'>new</span>(<span class='number'>5</span>);
    <span class='ident'>slot</span>
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>boxed</span> <span class='op'>=</span> <span class='ident'>helper</span>(); <span class='comment'>// Acquire ownership of return value</span>
}
</pre>

<h1 id="give-it-back!" class='section-header'><a
                           href="#give-it-back!">Give it back!</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>helper</span>(<span class='ident'>slot</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>u32</span><span class='op'>&gt;</span>) <span class='op'>-&gt;</span> <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>u32</span><span class='op'>&gt;</span> {
    <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;The number was {}&quot;</span>, <span class='ident'>slot</span>);
    <span class='ident'>slot</span>
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>slot</span> <span class='op'>=</span> <span class='ident'>Box</span>::<span class='ident'>new</span>(<span class='number'>5</span>);
    <span class='kw'>let</span> <span class='ident'>slot</span> <span class='op'>=</span> <span class='ident'>helper</span>(<span class='ident'>slot</span>);
    <span class='ident'>helper</span>(<span class='ident'>slot</span>);
}
</pre>

<p>Output:
<pre>
The number was 5
The number was 5
</pre></p>

<h1 id="borrowing" class='section-header'><a
                           href="#borrowing">Borrowing</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>helper</span>(<span class='ident'>slot</span>: <span class='kw-2'>&amp;</span><span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>u32</span><span class='op'>&gt;</span>) {
    <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;The number was {}&quot;</span>, <span class='ident'>slot</span>);
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>slot</span> <span class='op'>=</span> <span class='ident'>Box</span>::<span class='ident'>new</span>(<span class='number'>5</span>);
    <span class='ident'>helper</span>(<span class='kw-2'>&amp;</span><span class='ident'>slot</span>);
    <span class='ident'>helper</span>(<span class='kw-2'>&amp;</span><span class='ident'>slot</span>);
}
</pre>

<ul>
<li><code>&amp;</code> is a &quot;borrowed reference&quot;</li>
</ul>

<h1 id="borrowing-1" class='section-header'><a
                           href="#borrowing-1">Borrowing</a></h1>
<ul>
<li>Borrowing prevents moving</li>
</ul>
<pre id='rust-example-rendered' class='rust '>
<span class='kw'>let</span> <span class='ident'>v</span> <span class='op'>=</span> <span class='ident'>Vec</span>::<span class='ident'>new</span>();
<span class='kw'>let</span> <span class='ident'>vref</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='ident'>v</span>;
<span class='ident'>work_with</span>(<span class='ident'>v</span>);
</pre>

<p>Output:
<pre style="font-size: 22px">
&lt;anon&gt;:7:15: 7:16 error: cannot move out of <code>v</code> because it is borrowed
&lt;anon&gt;:7     work_with(v);
                       ^
&lt;anon&gt;:6:17: 6:18 note: borrow of <code>v</code> occurs here
&lt;anon&gt;:6     let vref = &v;
                         ^
</pre></p>

<h1 id="borrowing-2" class='section-header'><a
                           href="#borrowing-2">Borrowing</a></h1>
<ul>
<li>Also have <code>&amp;mut</code> - a borrowed, mutable reference</li>
<li>Cannot have both <code>&amp;</code> and <code>&amp;mut</code> at the same time</li>
<li>At most <code>&amp;mut</code> at any given time, but multiple <code>&amp;</code> are fine</li>
</ul>
<pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>push4</span>(<span class='ident'>v</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>u32</span><span class='op'>&gt;</span>) {
    <span class='ident'>v</span>.<span class='ident'>push</span>(<span class='number'>4</span>);
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>v</span> <span class='op'>=</span> <span class='macro'>vec</span><span class='macro'>!</span>[<span class='number'>1</span>, <span class='number'>2</span>, <span class='number'>3</span>];
    <span class='ident'>push4</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>v</span>);
    <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{:?}&quot;</span>, <span class='ident'>v</span>);
}
</pre>

<h1 id="borrowing-3" class='section-header'><a
                           href="#borrowing-3">Borrowing</a></h1>
<ul>
<li>All references exist for some <em>lifetime</em></li>
<li>Borrow must not outlive owner</li>
</ul>
<pre id='rust-example-rendered' class='rust '>
<span class='ident'>int</span> <span class='op'>*</span><span class='ident'>gimme_ref</span>() {
    <span class='ident'>int</span> <span class='ident'>a</span> <span class='op'>=</span> <span class='number'>42</span>;
    <span class='kw'>return</span> <span class='kw-2'>&amp;</span><span class='ident'>a</span>;
}

<span class='ident'>int</span> <span class='ident'>main</span>() {
    <span class='ident'>int</span> <span class='op'>*</span><span class='ident'>a</span> <span class='op'>=</span> <span class='ident'>gimme_ref</span>();
    <span class='ident'>printf</span>(<span class='string'>&quot;%d\n&quot;</span>, <span class='op'>*</span><span class='ident'>a</span>);
}
</pre>

<h1 id="borrowing-4" class='section-header'><a
                           href="#borrowing-4">Borrowing</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>gimme_ref</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span><span class='op'>&gt;</span>() <span class='op'>-&gt;</span> <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='ident'>u32</span> {
    <span class='kw'>let</span> <span class='ident'>a</span> <span class='op'>=</span> <span class='number'>42</span>;
    <span class='kw-2'>&amp;</span><span class='ident'>a</span>
}
<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>a</span>: <span class='kw-2'>&amp;</span><span class='ident'>u32</span> <span class='op'>=</span> <span class='ident'>gimme_ref</span>();
}
</pre>

<pre style="font-size: 18px">
&lt;anon&gt;:4:6: 4:7 error: `a` does not live long enough
&lt;anon&gt;:4     &a
              ^
&lt;anon&gt;:2:31: 5:2 note: reference must be valid for the lifetime 'a as defined on the block at 2:30...
&lt;anon&gt;:2 fn gimme_ref<'a>() -> &'a u32 {
&lt;anon&gt;:3     let a = 42;
&lt;anon&gt;:4     &a
&lt;anon&gt;:5 }
&lt;anon&gt;:3:15: 5:2 note: ...but borrowed value is only valid for the block suffix following statement 0 at 3:14
&lt;anon&gt;:3     let a = 42;
&lt;anon&gt;:4     &a
&lt;anon&gt;:5 }
</pre>

<h1 id="lifetimes" class='section-header'><a
                           href="#lifetimes">Lifetimes</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>helper</span>(<span class='ident'>x</span>: <span class='kw-2'>&amp;</span><span class='ident'>u32</span>) {   <span class='comment'>// --+ Borrow exists</span>
    <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{}&quot;</span>, <span class='ident'>x</span>); <span class='comment'>//   | for duration</span>
}                      <span class='comment'>// --+ of `helper`</span>

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>x</span> <span class='op'>=</span> <span class='number'>5</span>;
    <span class='ident'>helper</span>(<span class='kw-2'>&amp;</span><span class='ident'>x</span>);      <span class='comment'>// Borrow starts and ends here</span>
    <span class='ident'>x</span> <span class='op'>+=</span> <span class='number'>1</span>;          <span class='comment'>// Otherwise this wouldn&#39;t work</span>
    <span class='ident'>helper</span>(<span class='kw-2'>&amp;</span><span class='ident'>x</span>);
}
</pre>

<h1 id="lifetimes-1" class='section-header'><a
                           href="#lifetimes-1">Lifetimes</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>fn</span> <span class='ident'>helper</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span><span class='op'>&gt;</span>(<span class='ident'>x</span>: <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='ident'>u32</span>) {
    <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;{}&quot;</span>, <span class='ident'>x</span>);
}
</pre>

<ul>
<li>Most of the time <code>rustc</code> can infer lifetimes</li>
</ul>

<h1 id="life-&amp;-times" class='section-header'><a
                           href="#life-&amp;-times">Life &amp; times</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>struct</span> <span class='ident'>Foo</span> {
    <span class='ident'>x</span>: <span class='kw-2'>&amp;</span><span class='ident'>u32</span>
}
</pre>

<pre>
&lt;anon&gt;:2:8: 2:12 error: missing lifetime specifier [E0106]
&lt;anon&gt;:2     x: &amp;u32
                &#94;~~~
</pre>

<p>Instead:</p>
<pre id='rust-example-rendered' class='rust '>
<span class='kw'>struct</span> <span class='ident'>Foo</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span><span class='op'>&gt;</span> {
    <span class='ident'>x</span>: <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='ident'>u32</span>
}
</pre>

<h1 id="thinking-in-scopes" class='section-header'><a
                           href="#thinking-in-scopes">Thinking in scopes</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>let</span> <span class='ident'>v</span> <span class='op'>=</span> <span class='ident'>Vec</span>::<span class='ident'>new</span>();
{
    <span class='kw'>let</span> <span class='ident'>vref</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='ident'>v</span>;       <span class='comment'>// --+</span>
    <span class='comment'>// work with `vref`  //   | lifetime of `vref`</span>
}                        <span class='comment'>// --+</span>
<span class='ident'>work_with</span>(<span class='ident'>v</span>);
</pre>

<ul>
<li>Common idiom: Introduce scope to narrow lifetime</li>
</ul>

<h1 id="lifetimes-2" class='section-header'><a
                           href="#lifetimes-2">Lifetimes</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>struct</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='ident'>u32</span> }

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>a</span> <span class='op'>=</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='number'>0</span> };
    <span class='kw'>let</span> <span class='ident'>b</span> <span class='op'>=</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='number'>1</span> };

    <span class='kw'>if</span> <span class='ident'>a</span>.<span class='ident'>x</span> <span class='op'>&gt;</span> <span class='ident'>b</span>.<span class='ident'>x</span> {    <span class='comment'>// --+</span>
        <span class='ident'>process</span>(<span class='kw-2'>&amp;</span><span class='ident'>a</span>);  <span class='comment'>//   | We want to hide `if`</span>
    } <span class='kw'>else</span> {          <span class='comment'>//   | and only have one</span>
        <span class='ident'>process</span>(<span class='kw-2'>&amp;</span><span class='ident'>b</span>);  <span class='comment'>//   | invocation of `process`</span>
    }                 <span class='comment'>// --+</span>
}
</pre>

<h1 id="lifetimes-3" class='section-header'><a
                           href="#lifetimes-3">Lifetimes</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>struct</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='ident'>u32</span> }

<span class='kw'>fn</span> <span class='ident'>pick_one</span>(<span class='ident'>a</span>: <span class='kw-2'>&amp;</span><span class='ident'>Data</span>, <span class='ident'>b</span>: <span class='kw-2'>&amp;</span><span class='ident'>Data</span>) <span class='op'>-&gt;</span> <span class='kw-2'>&amp;</span><span class='ident'>Data</span> {
    <span class='kw'>if</span> <span class='ident'>a</span>.<span class='ident'>x</span> <span class='op'>&gt;</span> <span class='ident'>b</span>.<span class='ident'>x</span> { <span class='ident'>a</span> } <span class='kw'>else</span> { <span class='ident'>b</span> }
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>a</span> <span class='op'>=</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='number'>0</span> };
    <span class='kw'>let</span> <span class='ident'>b</span> <span class='op'>=</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='number'>1</span> };

    <span class='kw'>let</span> <span class='ident'>a_or_b</span> <span class='op'>=</span> <span class='ident'>pick_one</span>(<span class='kw-2'>&amp;</span><span class='ident'>a</span>, <span class='kw-2'>&amp;</span><span class='ident'>b</span>); <span class='comment'>// Points to either `a` or `b`</span>

    <span class='ident'>process</span>(<span class='ident'>a_or_b</span>);               <span class='comment'>// borrow of `a` and `b`</span>
}                                  <span class='comment'>// lasts until end</span>
</pre>

<h1 id="lifetimes-4" class='section-header'><a
                           href="#lifetimes-4">Lifetimes</a></h1><pre id='rust-example-rendered' class='rust '>
<span class='kw'>struct</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='ident'>u32</span> }

<span class='kw'>fn</span> <span class='ident'>pick_one</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span><span class='op'>&gt;</span>(<span class='ident'>a</span>: <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='ident'>Data</span>, <span class='ident'>b</span>: <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='ident'>Data</span>) <span class='op'>-&gt;</span> <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;a</span> <span class='ident'>Data</span> {
    <span class='kw'>if</span> <span class='ident'>a</span>.<span class='ident'>x</span> <span class='op'>&gt;</span> <span class='ident'>b</span>.<span class='ident'>x</span> { <span class='ident'>a</span> } <span class='kw'>else</span> { <span class='ident'>b</span> }
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>a</span> <span class='op'>=</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='number'>0</span> };
    <span class='kw'>let</span> <span class='ident'>b</span> <span class='op'>=</span> <span class='ident'>Data</span> { <span class='ident'>x</span>: <span class='number'>1</span> };

    <span class='kw'>let</span> <span class='ident'>a_or_b</span> <span class='op'>=</span> <span class='ident'>pick_one</span>(<span class='kw-2'>&amp;</span><span class='ident'>a</span>, <span class='kw-2'>&amp;</span><span class='ident'>b</span>); <span class='comment'>// Points to either `a` or `b`</span>

    <span class='ident'>process</span>(<span class='ident'>a_or_b</span>);               <span class='comment'>// borrow of `a` and `b`</span>
}                                  <span class='comment'>// lasts until end</span>
</pre>

<h1 id="special-lifetime:-&#39;static" class='section-header'><a
                           href="#special-lifetime:-&#39;static">Special lifetime: <code>&#39;static</code></a></h1>
<ul>
<li><code>&#39;static</code> is the lifetime of the entire program</li>
</ul>
<pre id='rust-example-rendered' class='rust '>
<span class='kw'>let</span> <span class='ident'>x</span>: <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;static</span> <span class='ident'>str</span> <span class='op'>=</span> <span class='string'>&quot;Hello, world.&quot;</span>;
</pre>

<h1 id="ownership-model" class='section-header'><a
                           href="#ownership-model">Ownership model</a></h1>
<ul>
<li>Prevents data races</li>
<li>Prevents a large class of memory errors</li>
<li>Does not require GC!</li>
<li>Has a learning curve...</li>
<li>Common for learners to &quot;fight with the borrow checker&quot;</li>
</ul>

<h1 id="great-talks-on-rust" class='section-header'><a
                           href="#great-talks-on-rust">Great talks on Rust</a></h1>
<ul>
<li><a href="mirror.linux.org.au/pub/linux.conf.au/2014/Friday/107-The_Rust_language_memory_ownership_and_lifetimes_-_Nicholas_Matsakis.mp4">Talk by Niko Matsakis</a> on Memory, Ownership and Lifetimes</li>
<li><a href="https://vimeo.com/120512790">Lars Bergstrom</a> An Introduction to Systems Programming with Rust</li>
</ul>

    <script type="text/javascript">
        window.playgroundUrl = "";
    </script>
    
</body>
</html>